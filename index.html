<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time Collaboration App</title>

    <!-- === FONT AWESOME (for toolbar icons) === -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-yQ03Kln...<omitted for brevity>..."
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- === STYLES === -->
    <style>
      /* Basic reset & layout */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #f4f4f6;
      }

      header {
        background: linear-gradient(135deg, #a2b9ff, #6d83e0);
        color: white;
        padding: 16px;
        text-align: center;
        font-size: 1.4rem;
        font-weight: 500;
      }

      /* Use Cases Toggle */
      #use-cases-button {
        padding: 10px 18px;
        background: #6d83e0;
        color: white;
        border: none;
        cursor: pointer;
        margin: 12px;
        font-size: 15px;
        border-radius: 6px;
        transition: background 0.2s ease;
      }
      #use-cases-button:hover {
        background: #5568b5;
      }

      /* Transition for fade in/out of Use Cases */
      #use-cases-container {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.4s ease, opacity 0.4s ease;
        margin: 0 12px;
        background: #ffffff;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 0 12px;
      }
      #use-cases-container.show {
        max-height: 300px;
        opacity: 1;
        padding: 12px;
      }
      #use-cases-container h3 {
        margin: 8px 0 12px;
      }
      #use-cases-container ul li {
        margin-bottom: 8px;
      }

      /* Main App Layout */
      .app-container {
        display: flex;
        flex: 1;
        overflow: hidden;
        color: #333;
      }
      .editor {
        flex: 2;
        display: flex;
        flex-direction: column;
        padding: 16px;
        border-right: 1px solid #ddd;
        position: relative;
      }
      .toolbar {
        margin-bottom: 12px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      /* Common button style for toolbar */
      .toolbar button {
        padding: 6px 10px;
        border: 1px solid #ccc;
        background: #fafafa;
        cursor: pointer;
        border-radius: 6px;
        transition: background 0.2s;
        font-size: 0.9rem;
      }
      .toolbar button:hover {
        background: #e5e5e5;
      }
      /* The color picker in the toolbar */
      #color-picker {
        width: 34px;
        height: 34px;
        border: none;
        background: transparent;
        cursor: pointer;
      }

      .content-area {
        flex: 1;
        border: 1px solid #ccc;
        padding: 16px;
        overflow-y: auto;
        position: relative;
        border-radius: 6px;
        background: #ffffff;
      }
      .placeholder {
        color: #aaa;
        pointer-events: none;
        position: absolute;
        top: 16px;
        left: 16px;
        font-style: italic;
      }

      /* Editor double-click highlight style */
      .double-click-highlight {
        background: #fcf3a2; /* mild yellow */
      }

      /* 
        Mouse Cursor Dots for all users (including me).
        We'll keep them, so "pen mode" doesn't remove them.
      */
      .user-cursor {
        position: absolute;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        transform: translate(-50%, -50%);
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .user-cursor::after {
        content: attr(data-name);
        position: absolute;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 10px;
        white-space: nowrap;
      }

      /* We'll remove the #add-comment-btn entirely from the DOM, so no style needed */

      /* 
        We do a "Pen Mode" overlay inside the .content-area 
        We'll place a canvas with the same size as contentArea
      */
      #pen-overlay {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 999;
        display: none; /* shown if pen is toggled */
        border-radius: 6px;
      }
      /* Pen Mode Cursor (override) */
      .pen-active {
        cursor: url("https://cdn-icons-png.flaticon.com/512/545/545674.png"),
          crosshair;
      }

      /* Sidebar */
      .sidebar {
        flex: 1;
        padding: 16px;
        background: #fefefe;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      .sidebar h2 {
        margin-bottom: 12px;
        font-size: 18px;
      }

      /* Responsive Layout (media query) */
      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
        }
        .editor {
          border-right: none;
          border-bottom: 1px solid #ccc;
        }
      }

      /* Message Section */
      .messages-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #message-form {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }
      #message-input {
        flex: 1;
        padding: 10px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      #message-form button {
        background: #6d83e0;
        border: none;
        color: #fff;
        cursor: pointer;
        border-radius: 6px;
        padding: 8px 14px;
        transition: background 0.2s ease;
      }
      #message-form button:hover {
        background: #5568b5;
      }

      #download-all-btn,
      #clear-all-messages-btn,
      #clear-all-comments-btn {
        background: #ccc;
        border: none;
        color: #333;
        border-radius: 6px;
        padding: 8px 14px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.2s ease;
        margin-left: 6px;
      }
      #download-all-btn:hover,
      #clear-all-messages-btn:hover,
      #clear-all-comments-btn:hover {
        background: #bbb;
      }

      /* Bubbles styling for messages */
      #messages {
        list-style: none;
        margin: 0;
        padding: 0;
        flex: 1;
        overflow-y: auto;
      }
      .message-item {
        margin-bottom: 10px;
        display: flex;
        align-items: flex-end;
        justify-content: flex-start;
      }
      .message-content {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 16px;
        position: relative;
        font-size: 14px;
        line-height: 1.4;
        background: #e1eafc;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .message-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #555;
        margin-bottom: 4px;
      }
      .message-user {
        font-weight: 600;
      }
      .message-time {
        font-style: italic;
      }
      .message-options {
        margin-left: 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .msg-btn {
        background: #999;
        border: none;
        border-radius: 6px;
        color: #fff;
        font-size: 12px;
        padding: 4px 6px;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .msg-btn:hover {
        background: #777;
      }

      /* Typing indicator bubble */
      #typing-indicators {
        margin-bottom: 8px;
      }
      .typing-bubble {
        display: inline-block;
        padding: 6px 10px;
        background: #c8f7c5;
        border-radius: 16px;
        margin-bottom: 8px;
        font-size: 14px;
        margin-right: 6px;
      }

      /* Comments List in sidebar */
      h3.comments-title {
        margin-top: 24px;
        font-size: 16px;
        border-top: 1px solid #ccc;
        padding-top: 12px;
      }
      #comments {
        list-style: none;
        margin: 0;
        padding: 0;
        flex: 0;
      }
      #comments li {
        padding: 10px;
        margin-bottom: 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        position: relative;
        font-size: 14px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #comments li .comment-text {
        margin-right: 60px;
      }
      .comment-author {
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
      }
      .edit-comment,
      .delete-comment {
        position: absolute;
        top: 10px;
        background: #888;
        color: #fff;
        border: none;
        cursor: pointer;
        padding: 4px 6px;
        font-size: 12px;
        border-radius: 4px;
        transition: background 0.2s ease;
      }
      .edit-comment:hover,
      .delete-comment:hover {
        background: #555;
      }
      .edit-comment {
        right: 40px;
      }
      .delete-comment {
        right: 10px;
        background: #e33f3f;
      }

      /* Real-time selection highlight in the editor */
      .realtime-highlight {
        background: #fcf3a2;
      }
    </style>
  </head>

  <body>
    <!-- HEADER -->
    <header>Real-Time Collaboration App (Sleek + Modern)</header>

    <!-- USE CASES TOGGLE BUTTON AND CONTAINER -->
    <button id="use-cases-button">Show/Hide Use Cases</button>
    <div id="use-cases-container">
      <h3>Use Cases:</h3>
      <ul>
        <li>
          <strong>Real-Time Speech Notes:</strong> As students speak,
          instructors and peers type in real-time feedback.
        </li>
        <li>
          <strong>Speaking Practice with Instant Corrections:</strong>
          The instructor types corrections as students speak.
        </li>
        <li>
          <strong>Pronunciation Drills:</strong>
          Highlight problematic words and add comments with phonetic guides.
        </li>
      </ul>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="app-container">
      <!-- Editor Pane -->
      <div class="editor">
        <!-- Toolbar -->
        <div id="toolbar" class="toolbar">
          <!-- Bold -->
          <button data-action="bold" title="Bold">
            <i class="fa-solid fa-bold"></i>
          </button>
          <!-- Italic -->
          <button data-action="italic" title="Italic">
            <i class="fa-solid fa-italic"></i>
          </button>
          <!-- Underline -->
          <button data-action="underline" title="Underline">
            <i class="fa-solid fa-underline"></i>
          </button>
          <!-- Highlight -->
          <button data-action="highlight" title="Highlight Selection">
            <i class="fa-solid fa-highlighter"></i>
          </button>
          <!-- StrikeThrough -->
          <button data-action="strikeThrough" title="Strike Through">
            <i class="fa-solid fa-strikethrough"></i>
          </button>
          <!-- Justify Left -->
          <button data-action="justifyLeft" title="Align Left">
            <i class="fa-solid fa-align-left"></i>
          </button>
          <!-- Justify Center -->
          <button data-action="justifyCenter" title="Align Center">
            <i class="fa-solid fa-align-center"></i>
          </button>
          <!-- Justify Right -->
          <button data-action="justifyRight" title="Align Right">
            <i class="fa-solid fa-align-right"></i>
          </button>
          <!-- Undo -->
          <button data-action="undo" title="Undo">
            <i class="fa-solid fa-rotate-left"></i>
          </button>
          <!-- Redo -->
          <button data-action="redo" title="Redo">
            <i class="fa-solid fa-rotate-right"></i>
          </button>
          <!-- Font Size -->
          <select data-action="fontSize" title="Font Size">
            <option value="">Size</option>
            <option value="1">x-small</option>
            <option value="3">normal</option>
            <option value="5">large</option>
            <option value="7">huge</option>
          </select>
          <!-- Font Family -->
          <select data-action="fontName" title="Font Family">
            <option value="">Font</option>
            <option value="Arial">Arial</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Times New Roman">Times</option>
            <option value="Courier New">Courier</option>
          </select>
          <!-- Color picker -->
          <input type="color" id="color-picker" title="Pick a color" />
          <!-- Pen (to draw freehand in overlay) -->
          <button data-action="pen" title="Toggle Pen Mode">
            <i class="fa-solid fa-pen"></i>
          </button>
        </div>

        <!-- Content Area (editable) -->
        <div id="content-area" contenteditable="true" class="content-area">
          <!-- We'll place a .placeholder if empty -->
          <!-- We'll also put the pen overlay canvas inside here -->
          <canvas id="pen-overlay"></canvas>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <div class="messages-header">
          <h2>Messages</h2>
          <div>
            <button id="download-all-btn" title="Download all messages">
              DL All
            </button>
            <button id="clear-all-messages-btn" title="Clear All Messages">
              Clear All
            </button>
          </div>
        </div>

        <!-- Message Form -->
        <form id="message-form">
          <input
            type="text"
            id="message-input"
            placeholder="Type your message..."
            required
          />
          <button type="submit" title="Send Message">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </form>

        <!-- Typing Indicators -->
        <div id="typing-indicators"></div>

        <!-- UL for messages -->
        <ul id="messages"></ul>

        <h3 class="comments-title">
          Comments
          <button id="clear-all-comments-btn" title="Clear All Comments">
            Clear All
          </button>
        </h3>
        <ul id="comments"></ul>
      </div>
    </div>

    <!-- === SCRIPTS === -->
    <script type="module">
      /****************************************
       * 1) FIREBASE SETUP
       ****************************************/
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";

      import {
        getDatabase,
        ref,
        set,
        onValue,
        push,
        remove,
        update,
        get,
      } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDNwApaLmfjk1cZBA0kZZMkYEnr39VZUyg",
        authDomain: "realtimecollabapp.firebaseapp.com",
        databaseURL: "https://realtimecollabapp-default-rtdb.firebaseio.com",
        projectId: "realtimecollabapp",
        storageBucket: "realtimecollabapp.firebasestorage.app",
        messagingSenderId: "955627884879",
        appId: "1:955627884879:web:4f5159d814956ed1ce753a",
        measurementId: "G-9311P887T1",
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      /****************************************
       * 2) USER NICKNAME (PROMPT ONCE)
       ****************************************/
      let nickname = localStorage.getItem("nickname");
      if (!nickname) {
        nickname = prompt("Enter your nickname:");
        if (!nickname) {
          nickname = "Anonymous_" + Math.floor(Math.random() * 1000);
        }
        localStorage.setItem("nickname", nickname);
      }

      /****************************************
       * 3) DOM ELEMENTS
       ****************************************/
      const contentArea = document.getElementById("content-area");
      const toolbar = document.getElementById("toolbar");
      const colorPicker = document.getElementById("color-picker");

      const useCasesButton = document.getElementById("use-cases-button");
      const useCasesContainer = document.getElementById("use-cases-container");

      // Messages
      const messageForm = document.getElementById("message-form");
      const messageInput = document.getElementById("message-input");
      const messagesList = document.getElementById("messages");
      const downloadAllBtn = document.getElementById("download-all-btn");
      const clearAllMsgsBtn = document.getElementById("clear-all-messages-btn");

      // Typing
      const typingIndicators = document.getElementById("typing-indicators");

      // Comments
      const commentsList = document.getElementById("comments");
      const clearAllCommentsBtn = document.getElementById(
        "clear-all-comments-btn"
      );

      // Pen Overlay
      const penOverlay = document.getElementById("pen-overlay");

      /****************************************
       * 4) ADD SOUNDS
       ****************************************/
      const sendSound = new Audio(
        "https://actions.google.com/sounds/v1/cartoon/slide_whistle_tooting.ogg"
      );
      const typingSound = new Audio(
        "https://actions.google.com/sounds/v1/foley/power_up_03.ogg"
      );
      // Lower volumes
      sendSound.volume = 0.3;
      typingSound.volume = 0.2;

      /****************************************
       * 5) USE CASES TOGGLE (WITH TRANSITION)
       ****************************************/
      useCasesButton.addEventListener("click", () => {
        useCasesContainer.classList.toggle("show");
      });

      /****************************************
       * 6) EDITOR PLACEHOLDER HANDLING
       ****************************************/
      function updatePlaceholder() {
        if (!contentArea.innerText.trim()) {
          if (!document.querySelector(".placeholder")) {
            const placeholderEl = document.createElement("div");
            placeholderEl.innerText = "Start typing here...";
            placeholderEl.className = "placeholder";
            contentArea.appendChild(placeholderEl);
          }
        } else {
          const ph = document.querySelector(".placeholder");
          if (ph) ph.remove();
        }
      }
      updatePlaceholder();

      /****************************************
       * 7) REAL-TIME EDITOR SYNC & CURSOR MGMT
       ****************************************/
      let localChange = false; // prevents overwriting local user changes

      contentArea.addEventListener("input", () => {
        localChange = true;
        const content = contentArea.innerHTML;
        const selection = window.getSelection();
        const cursorPosition = selection.focusOffset || 0;

        set(ref(db, "content"), {
          content,
          cursorPosition,
          lastEditBy: nickname,
        });

        // quick highlight flash
        contentArea.style.backgroundColor = "#eef2ff";
        setTimeout(() => {
          contentArea.style.backgroundColor = "white";
        }, 400);

        updatePlaceholder();
      });

      onValue(ref(db, "content"), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        if (!localChange) {
          if (data.content !== contentArea.innerHTML) {
            contentArea.innerHTML = data.content;
          }
          const range = document.createRange();
          const selection = window.getSelection();
          let pos = data.cursorPosition || 0;

          if (contentArea.firstChild) {
            const nodeLength = contentArea.firstChild.length || 0;
            range.setStart(contentArea.firstChild, Math.min(pos, nodeLength));
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
          }
        }
        localChange = false;
        updatePlaceholder();
      });

      /****************************************
       * 8) DOUBLE-CLICK TO HIGHLIGHT A WORD
       ****************************************/
      contentArea.addEventListener("dblclick", (e) => {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        if (!range.collapsed) {
          const span = document.createElement("span");
          span.className = "double-click-highlight";
          range.surroundContents(span);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      });

      /****************************************
       * 9) CONTEXT MENU FOR ADD COMMENT
       ****************************************/
      contentArea.addEventListener("contextmenu", (e) => {
        const sel = window.getSelection();
        if (sel && !sel.isCollapsed) {
          e.preventDefault();
          const wantComment = confirm("Add comment on selected text?");
          if (wantComment) {
            handleAddComment(sel.toString());
          }
        }
      });

      function handleAddComment(selectedText) {
        if (!selectedText.trim()) return;
        const userComment = prompt("Add a comment for: " + selectedText);
        if (userComment) {
          const startIndex = contentArea.innerText.indexOf(selectedText);
          push(ref(db, "comments"), {
            text: selectedText,
            comment: userComment,
            startIndex,
            length: selectedText.length,
            timestamp: new Date().toISOString(),
            user: nickname,
          });
        }
      }

      /****************************************
       * 10) REAL-TIME HIGHLIGHTING
       ****************************************/
      // We'll keep the same approach for live selection highlight.
      // But we won't show any "Add Comment" button.

      let lastSelectionRange = null;
      contentArea.addEventListener("mouseup", (e) => {
        const sel = window.getSelection();
        if (sel && sel.rangeCount > 0) {
          const range = sel.getRangeAt(0);
          if (!range.collapsed) {
            lastSelectionRange = range;
            storeSelectionInDB(range);
          } else {
            set(ref(db, "liveSelection"), null);
            lastSelectionRange = null;
          }
        }
      });

      function storeSelectionInDB(range) {
        const fullText = contentArea.innerText;
        const selectionText = range.toString();
        const startIndex = fullText.indexOf(selectionText);
        if (startIndex < 0) return;

        set(ref(db, "liveSelection"), {
          text: selectionText,
          startIndex,
          length: selectionText.length,
          user: nickname,
        });
      }

      onValue(ref(db, "liveSelection"), (snapshot) => {
        const selData = snapshot.val();
        removeAllHighlights();
        if (!selData) return;
        highlightRange(selData.startIndex, selData.length);
      });

      function removeAllHighlights() {
        const highlighted = contentArea.querySelectorAll(".realtime-highlight");
        highlighted.forEach((span) => {
          const parent = span.parentNode;
          while (span.firstChild) {
            parent.insertBefore(span.firstChild, span);
          }
          parent.removeChild(span);
        });
      }

      function highlightRange(startIndex, length) {
        const text = contentArea.innerText;
        if (startIndex < 0 || startIndex + length > text.length) return;

        const before = text.slice(0, startIndex);
        const selectionText = text.slice(startIndex, startIndex + length);
        const after = text.slice(startIndex + length);

        const highlightedHTML = `
          ${escapeHtml(before)}
          <span class="realtime-highlight">${escapeHtml(selectionText)}</span>
          ${escapeHtml(after)}
        `;
        contentArea.innerHTML = highlightedHTML;
      }

      function escapeHtml(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      /****************************************
       * 11) MESSAGES: SEND, DISPLAY, CLEAR ALL
       ****************************************/
      let typingTimeout = null;
      const TYPING_TIMER_LENGTH = 2000; // 2s

      messageForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;

        const newMessageRef = push(ref(db, "messages"));
        set(newMessageRef, {
          text,
          user: nickname,
          timestamp: Date.now(),
        });

        // play a sound
        sendSound.currentTime = 0;
        sendSound.play();

        messageInput.value = "";
        // clear typing state
        set(ref(db, `typing/${nickname}`), null);
      });

      messageInput.addEventListener("input", () => {
        // user is typing
        typingSound.currentTime = 0;
        typingSound.play();

        set(ref(db, `typing/${nickname}`), { user: nickname });
        if (typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          set(ref(db, `typing/${nickname}`), null);
        }, TYPING_TIMER_LENGTH);
      });

      onValue(ref(db, "messages"), (snapshot) => {
        const messages = snapshot.val();
        messagesList.innerHTML = "";
        if (messages) {
          Object.keys(messages).forEach((key) => {
            const m = messages[key];

            // Build bubble
            const li = document.createElement("li");
            li.classList.add("message-item");

            const bubble = document.createElement("div");
            bubble.classList.add("message-content");

            // Format time
            const timeObj = new Date(m.timestamp || Date.now());
            const timeStr = timeObj.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });

            bubble.innerHTML = `
              <div class="message-meta">
                <span class="message-user">${m.user}</span>
                <span class="message-time">${timeStr}</span>
              </div>
              <div>${m.text}</div>
            `;

            // Buttons
            const opts = document.createElement("div");
            opts.classList.add("message-options");

            const editBtn = document.createElement("button");
            editBtn.className = "msg-btn";
            editBtn.innerHTML = `<i class="fa-solid fa-edit"></i>`;
            editBtn.title = "Edit this message";
            editBtn.addEventListener("click", () => editMessage(key, m.text));

            const delBtn = document.createElement("button");
            delBtn.className = "msg-btn";
            delBtn.innerHTML = `<i class="fa-solid fa-trash"></i>`;
            delBtn.title = "Delete this message";
            delBtn.addEventListener("click", () => deleteMessage(key));

            const dlBtn = document.createElement("button");
            dlBtn.className = "msg-btn";
            dlBtn.innerHTML = `<i class="fa-solid fa-download"></i>`;
            dlBtn.title = "Download this message";
            dlBtn.addEventListener("click", () => downloadMessage(m.text));

            opts.appendChild(editBtn);
            opts.appendChild(delBtn);
            opts.appendChild(dlBtn);

            li.appendChild(bubble);
            li.appendChild(opts);
            messagesList.appendChild(li);
          });
        }
      });

      function editMessage(key, oldText) {
        const newText = prompt("Edit message:", oldText);
        if (newText !== null && newText.trim() !== "") {
          update(ref(db, `messages/${key}`), {
            text: newText,
          });
        }
      }
      function deleteMessage(key) {
        remove(ref(db, `messages/${key}`));
      }
      window.downloadMessage = (text) => {
        const blob = new Blob([text], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "message.txt";
        a.click();
      };

      downloadAllBtn.addEventListener("click", async () => {
        const snap = await get(ref(db, "messages"));
        if (!snap.exists()) return;

        const messages = snap.val();
        let content = "";
        Object.values(messages).forEach((m) => {
          // Also add time
          const timeStr = new Date(m.timestamp).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });
          content += `[${m.user} @ ${timeStr}] ${m.text}\n`;
        });
        const blob = new Blob([content], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "all_messages.txt";
        a.click();
      });

      clearAllMsgsBtn.addEventListener("click", () => {
        const sure = confirm("Are you sure you want to clear ALL messages?");
        if (sure) {
          remove(ref(db, "messages"));
        }
      });

      /****************************************
       * 12) TYPING INDICATORS
       ****************************************/
      onValue(ref(db, "typing"), (snapshot) => {
        const typingState = snapshot.val() || {};
        typingIndicators.innerHTML = "";

        Object.keys(typingState).forEach((k) => {
          if (k !== nickname) {
            const bubble = document.createElement("div");
            bubble.classList.add("typing-bubble");
            bubble.innerText = `${typingState[k].user} is typing...`;
            typingIndicators.appendChild(bubble);
          }
        });
      });

      /****************************************
       * 13) COMMENTS (ADD, EDIT, DELETE, CLEAR ALL)
       ****************************************/
      onValue(ref(db, "comments"), (snapshot) => {
        const comments = snapshot.val();
        commentsList.innerHTML = "";
        if (comments) {
          Object.keys(comments).forEach((key) => {
            const c = comments[key];
            const li = document.createElement("li");
            li.innerHTML = `
              <div class="comment-text">
                <span class="comment-author">${c.user}</span>
                <strong>${c.text}</strong><br/>
                <em>${c.comment}</em>
              </div>
              <button class="edit-comment" title="Edit Comment" onclick="editComment('${key}')">
                <i class="fa-solid fa-edit"></i>
              </button>
              <button class="delete-comment" title="Delete Comment" onclick="deleteComment('${key}')">
                <i class="fa-solid fa-trash"></i>
              </button>
            `;
            commentsList.appendChild(li);
          });
        }
      });

      clearAllCommentsBtn.addEventListener("click", () => {
        const sure = confirm("Are you sure you want to clear ALL comments?");
        if (sure) {
          remove(ref(db, "comments"));
        }
      });

      window.editComment = (key) => {
        get(ref(db, `comments/${key}`)).then((snapshot) => {
          if (snapshot.exists()) {
            const commentData = snapshot.val();
            const newComment = prompt(
              "Edit your comment:",
              commentData.comment
            );
            if (newComment !== null && newComment.trim() !== "") {
              update(ref(db, `comments/${key}`), {
                comment: newComment,
              });
            }
          }
        });
      };
      window.deleteComment = (key) => {
        remove(ref(db, `comments/${key}`));
      };

      /****************************************
       * 14) TOOLBAR (ROBUST ACTIONS + PEN)
       ****************************************/
      toolbar.addEventListener("click", (event) => {
        const { action } = event.target.dataset;
        if (!action) return;

        // In case the target is <i> inside the button
        const realAction = action || event.target.parentNode?.dataset?.action;
        if (!realAction) return;

        // Custom highlight
        if (realAction === "highlight") {
          highlightSelectedText();
          return;
        }

        // Pen: toggle pen mode
        if (realAction === "pen") {
          penMode = !penMode;
          togglePenMode(penMode);
          return;
        }

        // Otherwise, handle standard execCommand
        document.execCommand(realAction, false, null);
      });

      // For <select> changes
      toolbar.addEventListener("change", (event) => {
        const { action } = event.target.dataset;
        if (!action) return;

        const value = event.target.value;
        if (action === "fontSize") {
          document.execCommand("fontSize", false, value);
        } else if (action === "fontName") {
          document.execCommand("fontName", false, value);
        }
      });

      function highlightSelectedText() {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;
        if (document.queryCommandSupported("hiliteColor")) {
          document.execCommand("hiliteColor", false, "#fff59d");
        } else {
          document.execCommand("backColor", false, "#fff59d");
        }
      }

      /****************************************
       * 15) PEN MODE: FREEHAND DRAW OVERLAY
       ****************************************/
      let penMode = false;
      let drawing = false;
      let ctx = null;

      function togglePenMode(isOn) {
        if (isOn) {
          // Turn off contentEditable so the user doesn't accidentally type
          contentArea.contentEditable = "false";
          // Activate pen cursor
          contentArea.classList.add("pen-active");
          // Show overlay
          penOverlay.style.display = "block";
          setupCanvasOverlay();
        } else {
          // Re-enable typing
          contentArea.contentEditable = "true";
          // Hide pen cursor
          contentArea.classList.remove("pen-active");
          // Hide overlay
          penOverlay.style.display = "none";
        }
      }

      function setupCanvasOverlay() {
        const rect = contentArea.getBoundingClientRect();
        penOverlay.width = rect.width;
        penOverlay.height = rect.height;
        penOverlay.style.top = "0";
        penOverlay.style.left = "0";
        ctx = penOverlay.getContext("2d");
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
        ctx.lineWidth = 3;
        ctx.strokeStyle = colorPicker.value || "#000";
      }

      // Re-size or re-setup if window changes
      window.addEventListener("resize", () => {
        if (penMode) setupCanvasOverlay();
      });

      // Listen for drawing events
      penOverlay.addEventListener("mousedown", (e) => {
        if (!penMode) return;
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
      });
      penOverlay.addEventListener("mousemove", (e) => {
        if (!penMode || !drawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      });
      penOverlay.addEventListener("mouseup", () => {
        drawing = false;
      });
      penOverlay.addEventListener("mouseleave", () => {
        drawing = false;
      });

      // If color changes in pen mode, update stroke color
      colorPicker.addEventListener("input", () => {
        if (penMode && ctx) {
          ctx.strokeStyle = colorPicker.value;
        }
      });

      /****************************************
       * 16) LIVE CURSOR TRACKING (ALWAYS SHOW)
       ****************************************/
      let myCursorColor = localStorage.getItem("cursorColor");
      if (!myCursorColor) {
        const colors = [
          "#ff7777",
          "#77ff77",
          "#7777ff",
          "#ff77ff",
          "#77ffff",
          "#ffff77",
        ];
        myCursorColor = colors[Math.floor(Math.random() * colors.length)];
        localStorage.setItem("cursorColor", myCursorColor);
      }

      function updateCursorPosition(e) {
        const rect = contentArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        set(ref(db, `cursors/${nickname}`), {
          x,
          y,
          color: myCursorColor,
          name: nickname,
        });
      }

      contentArea.addEventListener("mousemove", (e) => {
        updateCursorPosition(e);
      });
      contentArea.addEventListener("mouseleave", (e) => {
        updateCursorPosition(e);
      });

      window.addEventListener("beforeunload", () => {
        remove(ref(db, `cursors/${nickname}`));
      });

      onValue(ref(db, "cursors"), (snapshot) => {
        const cursorsData = snapshot.val() || {};
        document.querySelectorAll(".user-cursor").forEach((el) => el.remove());
        // For every user (including me)
        Object.keys(cursorsData).forEach((user) => {
          const c = cursorsData[user];
          const dot = document.createElement("div");
          dot.classList.add("user-cursor");
          dot.style.backgroundColor = c.color;
          dot.style.left = c.x + "px";
          dot.style.top = c.y + "px";
          dot.setAttribute("data-name", c.name);
          contentArea.appendChild(dot);
        });
      });
    </script>
  </body>
</html>
