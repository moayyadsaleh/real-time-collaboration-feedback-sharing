<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time Collaboration App</title>

    <!-- === STYLES === -->
    <style>
      /* Basic reset & layout */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #f5f5f7; /* Light grey Apple-like background */
      }

      header {
        background: linear-gradient(135deg, #a2b9ff, #6d83e0);
        color: white;
        padding: 16px;
        text-align: center;
        font-size: 1.4rem;
        font-weight: 500;
      }

      /* Use Cases Toggle */
      #use-cases-button {
        padding: 12px 20px;
        background: #6d83e0;
        color: white;
        border: none;
        cursor: pointer;
        margin: 12px;
        font-size: 16px;
        border-radius: 6px;
        transition: background 0.2s ease;
      }
      #use-cases-button:hover {
        background: #5568b5;
      }

      /* Transition for fade in/out of Use Cases */
      #use-cases-container {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.4s ease, opacity 0.4s ease;
        margin: 0 12px;
        background: #ffffff;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      #use-cases-container.show {
        max-height: 300px;
        opacity: 1;
        padding: 12px;
      }
      #use-cases-container h3 {
        margin: 8px 0 12px;
      }
      #use-cases-container ul li {
        margin-bottom: 8px;
      }

      /* Main App Layout */
      .app-container {
        display: flex;
        flex: 1;
        overflow: hidden;
        color: #333;
      }
      .editor {
        flex: 2;
        display: flex;
        flex-direction: column;
        padding: 16px;
        border-right: 1px solid #ddd;
        position: relative;
      }
      .toolbar {
        margin-bottom: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .toolbar button {
        padding: 6px 12px;
        border: 1px solid #ccc;
        background: #fafafa;
        cursor: pointer;
        border-radius: 6px;
        transition: background 0.2s;
        font-size: 0.9rem;
      }
      .toolbar button:hover {
        background: #ebebeb;
      }
      .content-area {
        flex: 1;
        border: 1px solid #ccc;
        padding: 16px;
        overflow-y: auto;
        position: relative;
        border-radius: 6px;
        background: #ffffff;
      }
      .placeholder {
        color: #aaa;
        pointer-events: none;
        position: absolute;
        top: 16px;
        left: 16px;
        font-style: italic;
      }

      /* Editor double-click highlight style */
      .double-click-highlight {
        background: #fcf3a2; /* mild yellow */
      }

      /* Mouse Cursor Dots for all users (including me) */
      .user-cursor {
        position: absolute;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        transform: translate(-50%, -50%);
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .user-cursor::after {
        content: attr(data-name);
        position: absolute;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 10px;
        white-space: nowrap;
      }

      /* "Add Comment" button near selection */
      #add-comment-btn {
        display: none;
        position: absolute;
        padding: 8px 10px;
        background: #5568b5;
        color: #fff;
        cursor: pointer;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        z-index: 999;
      }
      #add-comment-btn:hover {
        background: #404e86;
      }

      /* Sidebar */
      .sidebar {
        flex: 1;
        padding: 16px;
        background: #fefefe;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      .sidebar h2 {
        margin-bottom: 12px;
        font-size: 18px;
      }

      /* Responsive Layout (media query) */
      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
        }
        .editor {
          border-right: none;
          border-bottom: 1px solid #ccc;
        }
      }

      /* Message Section */
      .messages-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #message-form {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }
      #message-input {
        flex: 1;
        padding: 10px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      #message-form button {
        background: #6d83e0;
        border: none;
        color: #fff;
        cursor: pointer;
        border-radius: 6px;
        padding: 8px 14px;
        transition: background 0.2s ease;
      }
      #message-form button:hover {
        background: #5568b5;
      }

      #download-all-btn,
      #clear-all-messages-btn,
      #clear-all-comments-btn {
        background: #ccc;
        border: none;
        color: #333;
        border-radius: 6px;
        padding: 8px 14px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.2s ease;
        margin-left: 6px;
      }
      #download-all-btn:hover,
      #clear-all-messages-btn:hover,
      #clear-all-comments-btn:hover {
        background: #bbb;
      }
      /* Overall styling for the message container */
      #messages {
        list-style: none;
        margin: 0;
        padding: 16px;
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px; /* Space between messages */
        background: #f5f5f5;
        font-family: "Arial", sans-serif;
      }

      /* Individual message styling */
      .message-item {
        display: flex;
        align-items: flex-end;
        justify-content: flex-start;
      }

      .message-item.sent {
        justify-content: flex-end;
      }

      .message-content {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        font-size: 16px;
        line-height: 1.5;
        background: linear-gradient(
          135deg,
          #d1eaff,
          #a3d8ff
        ); /* Gradient bubble */
        color: #000;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        word-wrap: break-word;
        overflow-wrap: break-word;
        transition: transform 0.2s ease, background 0.3s ease;
      }

      /* Add slight animation on hover */
      .message-content:hover {
        transform: scale(1.02);
        background: linear-gradient(135deg, #c0dbff, #8bc7ff);
      }

      /* Styling for received messages */
      .message-item.received .message-content {
        background: #ffffff;
        border: 1px solid #e6e6e6;
      }

      /* Rounded corners adjustment for alignment */
      .message-item.sent .message-content {
        border-top-right-radius: 4px;
      }
      .message-item.received .message-content {
        border-top-left-radius: 4px;
      }

      /* Timestamp or user info */
      .message-user {
        font-size: 12px;
        color: #666;
        margin-bottom: 6px;
        text-align: left;
      }

      /* Optional action buttons for messages */
      .message-options {
        margin-left: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .msg-btn {
        background: #4a90e2;
        border: none;
        border-radius: 8px;
        color: #fff;
        font-size: 12px;
        padding: 6px 8px;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      .msg-btn:hover {
        background: #357ab7;
        transform: translateY(-2px);
      }

      /* Responsive tweaks for smaller screens */
      @media screen and (max-width: 600px) {
        .message-content {
          max-width: 90%;
          font-size: 14px;
          padding: 10px 14px;
        }
      }
      /* Scroll-to-bottom button */
      #scroll-to-bottom {
        position: fixed;
        bottom: 16px;
        right: 16px;
        background: #4a90e2;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        z-index: 1000;
      }

      #scroll-to-bottom.visible {
        opacity: 1;
        visibility: visible;
      }

      #scroll-to-bottom::before {
        content: "â†“";
        font-size: 18px;
        font-weight: bold;
      }

      /* Responsive adjustments */
      @media screen and (max-width: 600px) {
        .message-item {
          font-size: 14px;
          padding: 12px;
        }
        #scroll-to-bottom {
          width: 36px;
          height: 36px;
        }
      }
      /* Responsive adjustments */
      @media screen and (max-width: 600px) {
        .message-item {
          font-size: 14px;
          padding: 12px;
        }
        #scroll-to-bottom {
          width: 36px;
          height: 36px;
        }
      }

      /* Typing indicator bubble */
      #typing-indicators {
        margin-bottom: 8px;
      }
      .typing-bubble {
        display: inline-block;
        padding: 6px 10px;
        background: #c8f7c5;
        border-radius: 16px;
        margin-bottom: 8px;
        font-size: 14px;
        margin-right: 6px;
      }

      /* Styling for the comments section */
      h3.comments-title {
        margin-top: 24px;
        font-size: 18px;
        font-weight: bold;
        color: #444;
        border-top: 2px solid #ddd;
        padding-top: 12px;
        text-align: center;
      }

      #comments {
        list-style: none;
        margin: 0;
        padding: 0;
        flex: 0; /* comments won't flex */
        background: #f9f9f9;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* Individual comment styling */
      #comments li {
        padding: 16px;
        margin-bottom: 12px;
        background: linear-gradient(135deg, #ffffff, #f0f0f0);
        border: 1px solid #ccc;
        border-radius: 12px;
        position: relative;
        font-size: 15px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.3s ease;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      /* Hover effect for comments */
      #comments li:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      /* Comment author styling */
      .comment-author {
        font-weight: bold;
        font-size: 14px;
        color: #333;
        margin-bottom: 6px;
      }

      /* Comment text content */
      .comment-text {
        margin-right: 80px;
        font-size: 14px;
        line-height: 1.5;
        color: #555;
      }

      /* Action buttons for edit and delete */
      .edit-comment,
      .delete-comment {
        position: absolute;
        top: 12px;
        color: #fff;
        border: none;
        cursor: pointer;
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 6px;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      /* Edit button styling */
      .edit-comment {
        right: 50px;
        background: #4a90e2;
      }

      .edit-comment:hover {
        background: #357ab7;
        transform: translateY(-2px);
      }

      /* Delete button styling */
      .delete-comment {
        right: 12px;
        background: #e33f3f;
      }

      .delete-comment:hover {
        background: #c12727;
        transform: translateY(-2px);
      }

      /* Responsive adjustments */
      @media screen and (max-width: 600px) {
        #comments li {
          font-size: 14px;
          padding: 12px;
        }
        .edit-comment,
        .delete-comment {
          font-size: 10px;
          padding: 4px 8px;
        }
        .edit-comment {
          right: 40px;
        }
        .delete-comment {
          right: 8px;
        }
      }

      /* Real-time selection highlight in the editor */
      .realtime-highlight {
        background: #fcf3a2;
      }

      /* Canvas Drawing Section */
      .canvas-container {
        margin-top: 16px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px;
        display: none; /* shown if toggled */
      }
      #draw-canvas {
        border: 1px solid #999;
        width: 100%;
        height: 300px;
        border-radius: 4px;
        background: #ffffff;
      }
      #toggle-canvas-btn {
        padding: 6px 12px;
        border: 1px solid #ccc;
        background: #fafafa;
        cursor: pointer;
        border-radius: 6px;
        transition: background 0.2s;
        font-size: 0.9rem;
      }
      #toggle-canvas-btn:hover {
        background: #ebebeb;
      }
    </style>
  </head>

  <body>
    <!-- === HEADER === -->
    <header>Real-Time Collaboration</header>

    <!-- === USE CASES TOGGLE BUTTON AND CONTAINER === -->
    <button id="use-cases-button" title="Show/Hide Use Cases">
      Show/Hide Use Cases
    </button>
    <div id="use-cases-container">
      <h3>Use Cases:</h3>
      <ul>
        <li>
          <strong>Real-Time Speech Notes:</strong> As students speak,
          instructors and peers type in real-time feedback.
        </li>
        <li>
          <strong>Speaking Practice with Instant Corrections:</strong>
          The instructor types corrections as students speak.
        </li>
        <li>
          <strong>Pronunciation Drills:</strong>
          Highlight problematic words and add comments with phonetic guides.
        </li>
      </ul>
    </div>

    <!-- === MAIN CONTAINER: Editor + Sidebar === -->
    <div class="app-container">
      <!-- Editor Pane -->
      <div class="editor">
        <!-- Toolbar -->
        <div id="toolbar" class="toolbar">
          <!-- Existing Buttons -->
          <button data-action="bold" title="Bold (Ctrl + B)">B</button>
          <button data-action="italic" title="Italic (Ctrl + I)">I</button>
          <button data-action="underline" title="Underline (Ctrl + U)">
            U
          </button>
          <!-- Fix highlight: We'll use our custom function for highlight -->
          <button data-action="highlight" title="Highlight Selection">
            HL
          </button>
          <!-- Additional robust actions -->
          <button data-action="strikeThrough" title="Strike Through">S</button>
          <button data-action="justifyLeft" title="Align Left">&#8676;</button>
          <button data-action="justifyCenter" title="Align Center">
            &#8677;
          </button>
          <button data-action="justifyRight" title="Align Right">
            &#8678;
          </button>
          <button data-action="undo" title="Undo (Ctrl + Z)">Undo</button>
          <button data-action="redo" title="Redo (Ctrl + Y)">Redo</button>
          <!-- Font size and family (example) -->
          <select data-action="fontSize" title="Font Size">
            <option value="">Size</option>
            <option value="1">x-small</option>
            <option value="3">normal</option>
            <option value="5">large</option>
            <option value="7">huge</option>
          </select>
          <select data-action="fontName" title="Font Family">
            <option value="">Font</option>
            <option value="Arial">Arial</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Times New Roman">Times</option>
            <option value="Courier New">Courier</option>
          </select>

          <!-- Toggle Canvas -->
          <button id="toggle-canvas-btn" title="Toggle Drawing Canvas">
            Canvas
          </button>
        </div>

        <!-- Content Area (editable) -->
        <div id="content-area" contenteditable="true" class="content-area">
          <!-- We'll place a .placeholder if empty -->
        </div>

        <!-- "Add Comment" button near the text selection -->
        <button id="add-comment-btn" title="Add a comment to selected text">
          Add Comment
        </button>

        <!-- Canvas Container for drawing -->
        <div class="canvas-container" id="canvas-container">
          <canvas id="draw-canvas"></canvas>
        </div>
      </div>

      <!-- Sidebar: Messages + Comments -->
      <div class="sidebar">
        <div class="messages-header">
          <h2>Messages</h2>
          <div>
            <button id="download-all-btn" title="Download all messages">
              DL All
            </button>
            <button id="clear-all-messages-btn" title="Clear All Messages">
              Clear All
            </button>
          </div>
        </div>

        <!-- Message Form to send real-time messages -->
        <form id="message-form">
          <input
            type="text"
            id="message-input"
            placeholder="Type your message..."
            required
          />
          <button type="submit" title="Send Message">Send</button>
        </form>

        <!-- Real-time typing indicator container -->
        <div id="typing-indicators"></div>

        <!-- UL for messages -->
        <ul id="messages"></ul>

        <h3 class="comments-title">
          Comments
          <button id="clear-all-comments-btn" title="Clear All Comments">
            Clear All
          </button>
        </h3>
        <ul id="comments"></ul>
      </div>
    </div>

    <!-- === SCRIPTS === -->
    <script type="module">
      /****************************************
       * 1) FIREBASE SETUP
       ****************************************/
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";

      import {
        getDatabase,
        ref,
        set,
        onValue,
        push,
        remove,
        update,
        get,
      } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

      // Replace with your own config
      const firebaseConfig = {
        apiKey: "AIzaSyDNwApaLmfjk1cZBA0kZZMkYEnr39VZUyg",
        authDomain: "realtimecollabapp.firebaseapp.com",
        databaseURL: "https://realtimecollabapp-default-rtdb.firebaseio.com",
        projectId: "realtimecollabapp",
        storageBucket: "realtimecollabapp.firebasestorage.app",
        messagingSenderId: "955627884879",
        appId: "1:955627884879:web:4f5159d814956ed1ce753a",
        measurementId: "G-9311P887T1",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      /****************************************
       * 2) USER NICKNAME (PROMPT ONCE)
       ****************************************/
      let nickname = localStorage.getItem("nickname");
      if (!nickname) {
        nickname = prompt("Enter your nickname:");
        if (!nickname) {
          nickname = "Anonymous_" + Math.floor(Math.random() * 1000);
        }
        localStorage.setItem("nickname", nickname);
      }

      /****************************************
       * 3) DOM ELEMENTS
       ****************************************/
      const contentArea = document.getElementById("content-area");
      const addCommentBtn = document.getElementById("add-comment-btn");
      const toolbar = document.getElementById("toolbar");
      const useCasesButton = document.getElementById("use-cases-button");
      const useCasesContainer = document.getElementById("use-cases-container");

      // Messages
      const messageForm = document.getElementById("message-form");
      const messageInput = document.getElementById("message-input");
      const messagesList = document.getElementById("messages");
      const downloadAllBtn = document.getElementById("download-all-btn");
      const clearAllMsgsBtn = document.getElementById("clear-all-messages-btn");

      // Typing
      const typingIndicators = document.getElementById("typing-indicators");

      // Comments
      const commentsList = document.getElementById("comments");
      const clearAllCommentsBtn = document.getElementById(
        "clear-all-comments-btn"
      );

      // Canvas
      const toggleCanvasBtn = document.getElementById("toggle-canvas-btn");
      const canvasContainer = document.getElementById("canvas-container");
      const drawCanvas = document.getElementById("draw-canvas");

      /****************************************
       * 4) ADD SOUNDS
       ****************************************/
      // Replace remote URLs with your mp3 file names:
      const sendSound = new Audio("audio1.mp3"); // For message delivery
      const typingSound = new Audio("audio2.mp3"); // For typing
      // Lower volumes a bit
      sendSound.volume = 0.3;
      typingSound.volume = 0.2;

      /****************************************
       * 5) USE CASES TOGGLE (WITH TRANSITION)
       ****************************************/
      useCasesButton.addEventListener("click", () => {
        useCasesContainer.classList.toggle("show");
      });

      /****************************************
       * 6) EDITOR PLACEHOLDER HANDLING
       ****************************************/
      function updatePlaceholder() {
        if (!contentArea.innerText.trim()) {
          if (!document.querySelector(".placeholder")) {
            const placeholderEl = document.createElement("div");
            placeholderEl.innerText = "Start typing here...";
            placeholderEl.className = "placeholder";
            contentArea.appendChild(placeholderEl);
          }
        } else {
          const ph = document.querySelector(".placeholder");
          if (ph) ph.remove();
        }
      }
      updatePlaceholder();

      /****************************************
       * 7) REAL-TIME EDITOR SYNC & CURSOR MGMT
       ****************************************/
      let localChange = false; // prevents overwriting local user changes

      contentArea.addEventListener("input", () => {
        localChange = true;
        const content = contentArea.innerHTML;
        const selection = window.getSelection();
        const cursorPosition = selection.focusOffset || 0;

        set(ref(db, "content"), {
          content,
          cursorPosition,
          lastEditBy: nickname,
        });

        // quick highlight flash
        contentArea.style.backgroundColor = "#eef2ff";
        setTimeout(() => {
          contentArea.style.backgroundColor = "white";
        }, 400);

        updatePlaceholder();
      });

      onValue(ref(db, "content"), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        if (!localChange) {
          if (data.content !== contentArea.innerHTML) {
            contentArea.innerHTML = data.content;
          }
          const range = document.createRange();
          const selection = window.getSelection();
          let pos = data.cursorPosition || 0;

          if (contentArea.firstChild) {
            const nodeLength = contentArea.firstChild.length || 0;
            range.setStart(contentArea.firstChild, Math.min(pos, nodeLength));
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
          }
        }
        localChange = false;
        updatePlaceholder();
      });

      /****************************************
       * 8) DOUBLE-CLICK TO HIGHLIGHT A WORD
       ****************************************/
      contentArea.addEventListener("dblclick", (e) => {
        // On double click, get the selection and highlight that word
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        // We'll wrap the word in a <span> with class="double-click-highlight"
        // But we must ensure we only highlight a single word
        if (!range.collapsed) {
          // might be multiple words, but let's keep it simple
          // We'll highlight whatever is selected
          const span = document.createElement("span");
          span.className = "double-click-highlight";
          range.surroundContents(span);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      });

      /****************************************
       * 9) CONTEXT MENU FOR ADD COMMENT
       ****************************************/
      contentArea.addEventListener("contextmenu", (e) => {
        const sel = window.getSelection();
        if (sel && !sel.isCollapsed) {
          e.preventDefault(); // prevent default context
          // Show a simple confirm as an example (or create a custom context menu)
          const wantComment = confirm("Add comment on selected text?");
          if (wantComment) {
            handleAddComment();
          }
        }
      });

      /****************************************
       * 10) REAL-TIME HIGHLIGHTING OF SELECTION
       ****************************************/
      let lastSelectionRange = null;

      function storeSelectionInDB(range) {
        if (!range) return;
        const startContainer = range.startContainer;
        const endContainer = range.endContainer;
        if (!startContainer || !endContainer) return;

        const fullText = contentArea.innerText;
        const selectionText = range.toString();
        const startIndex = fullText.indexOf(selectionText);
        if (startIndex < 0) return;

        set(ref(db, "liveSelection"), {
          text: selectionText,
          startIndex,
          length: selectionText.length,
          user: nickname,
        });
      }

      function handleAddComment() {
        if (!lastSelectionRange) return;
        const selectedText = lastSelectionRange.toString();
        if (!selectedText.trim()) return;

        const userComment = prompt("Add a comment for: " + selectedText);
        if (userComment) {
          const startIndex = contentArea.innerText.indexOf(selectedText);
          push(ref(db, "comments"), {
            text: selectedText,
            comment: userComment,
            startIndex,
            length: selectedText.length,
            timestamp: new Date().toISOString(),
            user: nickname,
          });
        }
        addCommentBtn.style.display = "none";
      }

      contentArea.addEventListener("mouseup", (e) => {
        const sel = window.getSelection();
        if (sel && sel.rangeCount > 0) {
          const range = sel.getRangeAt(0);
          if (!range.collapsed) {
            lastSelectionRange = range;
            storeSelectionInDB(range);

            addCommentBtn.style.display = "block";
            addCommentBtn.style.top = e.pageY - 40 + "px";
            addCommentBtn.style.left = e.pageX + "px";
          } else {
            set(ref(db, "liveSelection"), null);
            lastSelectionRange = null;
            addCommentBtn.style.display = "none";
          }
        }
      });

      addCommentBtn.addEventListener("click", () => {
        handleAddComment();
      });

      document.addEventListener("click", (e) => {
        if (!contentArea.contains(e.target) && e.target !== addCommentBtn) {
          addCommentBtn.style.display = "none";
        }
      });

      onValue(ref(db, "liveSelection"), (snapshot) => {
        const selData = snapshot.val();
        removeAllHighlights();
        if (!selData) return;
        highlightRange(selData.startIndex, selData.length);
      });

      function removeAllHighlights() {
        const highlighted = contentArea.querySelectorAll(".realtime-highlight");
        highlighted.forEach((span) => {
          const parent = span.parentNode;
          while (span.firstChild) {
            parent.insertBefore(span.firstChild, span);
          }
          parent.removeChild(span);
        });
      }

      function highlightRange(startIndex, length) {
        const text = contentArea.innerText;
        if (startIndex < 0 || startIndex + length > text.length) return;

        const before = text.slice(0, startIndex);
        const selectionText = text.slice(startIndex, startIndex + length);
        const after = text.slice(startIndex + length);

        const highlightedHTML = `
          ${escapeHtml(before)}
          <span class="realtime-highlight">${escapeHtml(selectionText)}</span>
          ${escapeHtml(after)}
        `;
        contentArea.innerHTML = highlightedHTML;
      }

      function escapeHtml(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      /****************************************
       * 11) MESSAGES: SEND, DISPLAY, CLEAR ALL
       ****************************************/
      let typingTimeout = null;
      const TYPING_TIMER_LENGTH = 2000; // 2s

      messageForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;

        // push to Firebase
        const newMessageRef = push(ref(db, "messages"));
        set(newMessageRef, {
          text,
          user: nickname,
          timestamp: Date.now(),
        });

        // play a sound
        sendSound.currentTime = 0;
        sendSound.play();

        messageInput.value = "";
        // clear typing state
        set(ref(db, `typing/${nickname}`), null);
      });

      messageInput.addEventListener("input", () => {
        // user is typing
        // play typing sound
        typingSound.currentTime = 0;
        typingSound.play();

        set(ref(db, `typing/${nickname}`), { user: nickname });
        if (typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          set(ref(db, `typing/${nickname}`), null);
        }, TYPING_TIMER_LENGTH);
      });

      // Listen for messages
      onValue(ref(db, "messages"), (snapshot) => {
        const messages = snapshot.val();
        messagesList.innerHTML = "";
        if (messages) {
          Object.keys(messages).forEach((key) => {
            const m = messages[key];
            const li = document.createElement("li");
            li.classList.add("message-item");

            const bubble = document.createElement("div");
            bubble.classList.add("message-content");
            bubble.innerHTML = `
              <div class="message-user">${m.user}</div>
              <div>${m.text}</div>
            `;

            const opts = document.createElement("div");
            opts.classList.add("message-options");

            // Edit button
            const editBtn = document.createElement("button");
            editBtn.className = "msg-btn";
            editBtn.innerText = "Edit";
            editBtn.title = "Edit this message";
            editBtn.addEventListener("click", () => editMessage(key, m.text));

            // Delete button
            const delBtn = document.createElement("button");
            delBtn.className = "msg-btn";
            delBtn.innerText = "Del";
            delBtn.title = "Delete this message";
            delBtn.addEventListener("click", () => deleteMessage(key));

            // Download single message
            const dlBtn = document.createElement("button");
            dlBtn.className = "msg-btn";
            dlBtn.innerText = "DL";
            dlBtn.title = "Download this message";
            dlBtn.addEventListener("click", () => downloadMessage(m.text));

            opts.appendChild(editBtn);
            opts.appendChild(delBtn);
            opts.appendChild(dlBtn);

            li.appendChild(bubble);
            li.appendChild(opts);
            messagesList.appendChild(li);
          });
        }
      });

      function editMessage(key, oldText) {
        const newText = prompt("Edit message:", oldText);
        if (newText !== null && newText.trim() !== "") {
          update(ref(db, `messages/${key}`), {
            text: newText,
          });
        }
      }
      function deleteMessage(key) {
        remove(ref(db, `messages/${key}`));
      }
      window.downloadMessage = (text) => {
        const blob = new Blob([text], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "message.txt";
        a.click();
      };

      // Download all messages
      downloadAllBtn.addEventListener("click", async () => {
        const snap = await get(ref(db, "messages"));
        if (!snap.exists()) return;

        const messages = snap.val();
        let content = "";
        Object.values(messages).forEach((m) => {
          content += `[${m.user}] ${m.text}\n`;
        });
        const blob = new Blob([content], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "all_messages.txt";
        a.click();
      });

      // Clear all messages
      clearAllMsgsBtn.addEventListener("click", () => {
        const sure = confirm("Are you sure you want to clear ALL messages?");
        if (sure) {
          remove(ref(db, "messages"));
        }
      });

      /****************************************
       * 12) TYPING INDICATORS
       ****************************************/
      onValue(ref(db, "typing"), (snapshot) => {
        const typingState = snapshot.val() || {};
        typingIndicators.innerHTML = "";

        Object.keys(typingState).forEach((k) => {
          if (k !== nickname) {
            // show that user is typing
            const bubble = document.createElement("div");
            bubble.classList.add("typing-bubble");
            bubble.innerText = `${typingState[k].user} is typing...`;
            typingIndicators.appendChild(bubble);
          }
        });
      });

      /****************************************
       * 13) COMMENTS (ADD, EDIT, DELETE, CLEAR ALL)
       ****************************************/
      onValue(ref(db, "comments"), (snapshot) => {
        const comments = snapshot.val();
        commentsList.innerHTML = "";
        if (comments) {
          Object.keys(comments).forEach((key) => {
            const c = comments[key];
            const li = document.createElement("li");
            li.innerHTML = `
              <div class="comment-text">
                <span class="comment-author">${c.user}</span>
                <strong>${c.text}</strong><br/>
                <em>${c.comment}</em>
              </div>
              <button class="edit-comment" title="Edit Comment" onclick="editComment('${key}')">
                Edit
              </button>
              <button class="delete-comment" title="Delete Comment" onclick="deleteComment('${key}')">
                Del
              </button>
            `;
            commentsList.appendChild(li);
          });
        }
      });

      clearAllCommentsBtn.addEventListener("click", () => {
        const sure = confirm("Are you sure you want to clear ALL comments?");
        if (sure) {
          remove(ref(db, "comments"));
        }
      });

      window.editComment = (key) => {
        get(ref(db, `comments/${key}`)).then((snapshot) => {
          if (snapshot.exists()) {
            const commentData = snapshot.val();
            const newComment = prompt(
              "Edit your comment:",
              commentData.comment
            );
            if (newComment !== null && newComment.trim() !== "") {
              update(ref(db, `comments/${key}`), {
                comment: newComment,
              });
            }
          }
        });
      };
      window.deleteComment = (key) => {
        remove(ref(db, `comments/${key}`));
      };

      /****************************************
       * 14) TOOLBAR (ROBUST ACTIONS)
       ****************************************/
      toolbar.addEventListener("click", (event) => {
        const { action } = event.target.dataset;
        if (!action) return;

        if (action === "highlight") {
          // Our custom highlight logic
          highlightSelectedText();
        } else {
          // For everything else, just execCommand
          document.execCommand(action, false, null);
        }
      });

      // For <select> changes
      toolbar.addEventListener("change", (event) => {
        const { action } = event.target.dataset;
        if (!action) return;

        const value = event.target.value;
        if (action === "fontSize") {
          document.execCommand("fontSize", false, value);
        } else if (action === "fontName") {
          document.execCommand("fontName", false, value);
        }
      });

      // Fix highlight button with a custom color
      function highlightSelectedText() {
        // We'll highlight with a mild yellow
        const selection = window.getSelection();
        if (!selection.rangeCount) return;
        // execCommand is inconsistent for 'backColor' in some browsers
        // We'll try 'hiliteColor' first
        if (document.queryCommandSupported("hiliteColor")) {
          document.execCommand("hiliteColor", false, "#fff59d");
        } else {
          document.execCommand("backColor", false, "#fff59d");
        }
      }

      /****************************************
       * 15) LIVE CURSOR TRACKING (ALWAYS SHOW)
       ****************************************/
      let myCursorColor = localStorage.getItem("cursorColor");
      if (!myCursorColor) {
        const colors = [
          "#ff7777",
          "#77ff77",
          "#7777ff",
          "#ff77ff",
          "#77ffff",
          "#ffff77",
        ];
        myCursorColor = colors[Math.floor(Math.random() * colors.length)];
        localStorage.setItem("cursorColor", myCursorColor);
      }

      // Track local user mouse (even if not moving)
      contentArea.addEventListener("mousemove", (e) => {
        updateCursorPosition(e);
      });
      contentArea.addEventListener("mouseleave", (e) => {
        // We won't remove it so user always sees their cursor
        // but we could hide it if we wanted.
        updateCursorPosition(e);
      });

      function updateCursorPosition(e) {
        const rect = contentArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        set(ref(db, `cursors/${nickname}`), {
          x,
          y,
          color: myCursorColor,
          name: nickname,
        });
      }

      // Clear cursor if user leaves page
      window.addEventListener("beforeunload", () => {
        remove(ref(db, `cursors/${nickname}`));
      });

      // Listen for cursors
      onValue(ref(db, "cursors"), (snapshot) => {
        const cursorsData = snapshot.val() || {};
        // Remove all existing .user-cursor elements
        document.querySelectorAll(".user-cursor").forEach((el) => el.remove());

        // For every user (including me)
        Object.keys(cursorsData).forEach((user) => {
          const c = cursorsData[user];
          const dot = document.createElement("div");
          dot.classList.add("user-cursor");
          dot.style.backgroundColor = c.color;
          dot.style.left = c.x + "px";
          dot.style.top = c.y + "px";
          dot.setAttribute("data-name", c.name);
          contentArea.appendChild(dot);
        });
      });

      /****************************************
       * 16) CANVAS DRAWING
       ****************************************/
      let drawing = false;
      let ctx = null;

      // Toggle canvas
      toggleCanvasBtn.addEventListener("click", () => {
        canvasContainer.style.display =
          canvasContainer.style.display === "none" ? "block" : "none";
      });

      // Setup canvas
      function setupCanvas() {
        // Retinal scaling
        const dpr = window.devicePixelRatio || 1;
        const rect = drawCanvas.getBoundingClientRect();
        drawCanvas.width = rect.width * dpr;
        drawCanvas.height = rect.height * dpr;
        ctx = drawCanvas.getContext("2d");
        ctx.scale(dpr, dpr);
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
        ctx.lineWidth = 3;
        ctx.strokeStyle = "#1c1c1c";
      }

      setupCanvas();
      window.addEventListener("resize", setupCanvas);

      drawCanvas.addEventListener("mousedown", (e) => {
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(getX(e), getY(e));
      });
      drawCanvas.addEventListener("mousemove", (e) => {
        if (!drawing) return;
        ctx.lineTo(getX(e), getY(e));
        ctx.stroke();
      });
      drawCanvas.addEventListener("mouseup", () => {
        drawing = false;
      });
      drawCanvas.addEventListener("mouseleave", () => {
        drawing = false;
      });

      function getX(e) {
        return e.offsetX;
      }
      function getY(e) {
        return e.offsetY;
      }
    </script>
  </body>
</html>
